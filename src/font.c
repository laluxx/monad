/*
 * @file font.c
 * @version 0.0.2
 * Font rendering implementation
 */

#include "font.h"

#ifndef NULL
#define NULL ((void*)0)
#endif

#ifdef USE_FRAMEBUFFER
#if USE_FRAMEBUFFER

// Only compile font code when framebuffer is enabled

static Font *default_font = NULL;

// Simple memory allocation (1MB pool only when needed)
static uint8_t font_memory_pool[1024 * 1024];
static uint32_t font_memory_offset = 0;

static void* font_malloc(uint32_t size) {
    if (font_memory_offset + size > sizeof(font_memory_pool)) {
        return NULL;
    }
    void *ptr = &font_memory_pool[font_memory_offset];
    font_memory_offset += size;
    return ptr;
}

int font_init(void) {
    font_memory_offset = 0;
    default_font = NULL;
    return 0;
}

Font* font_load_ttf(const uint8_t *ttf_data, uint32_t size, uint32_t font_size) {
    (void)ttf_data;
    (void)size;
    (void)font_size;
    // TODO: Use FreeType to load TTF fonts
    return NULL;
}

void font_free(Font *font) {
    (void)font;
    // Free font resources
}

void font_set_default(Font *font) {
    default_font = font;
}

Font* font_get_default(void) {
    return default_font;
}

uint32_t font_get_height(Font *font) {
    if (font) {
        return font->ascent - font->descent + font->line_gap;
    }
    return 16;
}

// Built-in 8x16 bitmap font (only compile when framebuffer enabled)
const uint8_t builtin_font_8x16[256][16] = {
    [0 ... 31] = {0},

    [' '] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

    ['!'] = {0x00, 0x00, 0x18, 0x3C, 0x3C, 0x3C, 0x18, 0x18,
             0x18, 0x00, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00},

    ['"'] = {0x00, 0x66, 0x66, 0x66, 0x24, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

    ['('] = {0x00, 0x0C, 0x18, 0x30, 0x30, 0x30, 0x30, 0x30,
             0x30, 0x30, 0x30, 0x18, 0x0C, 0x00, 0x00, 0x00},

    [')'] = {0x00, 0x30, 0x18, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C,
             0x0C, 0x0C, 0x0C, 0x18, 0x30, 0x00, 0x00, 0x00},

    ['0'] = {0x00, 0x00, 0x3C, 0x66, 0x6E, 0x7E, 0x76, 0x66,
             0x66, 0x66, 0x3C, 0x00, 0x00, 0x00, 0x00, 0x00},
    ['1'] = {0x00, 0x00, 0x18, 0x38, 0x18, 0x18, 0x18, 0x18,
             0x18, 0x18, 0x7E, 0x00, 0x00, 0x00, 0x00, 0x00},
    ['2'] = {0x00, 0x00, 0x3C, 0x66, 0x06, 0x0C, 0x18, 0x30,
             0x60, 0x66, 0x7E, 0x00, 0x00, 0x00, 0x00, 0x00},
    ['3'] = {0x00, 0x00, 0x3C, 0x66, 0x06, 0x06, 0x1C, 0x06,
             0x06, 0x66, 0x3C, 0x00, 0x00, 0x00, 0x00, 0x00},
    ['4'] = {0x00, 0x00, 0x0C, 0x1C, 0x3C, 0x6C, 0x6C, 0xFE,
             0x0C, 0x0C, 0x1E, 0x00, 0x00, 0x00, 0x00, 0x00},
    ['5'] = {0x00, 0x00, 0x7E, 0x60, 0x60, 0x7C, 0x06, 0x06,
             0x06, 0x66, 0x3C, 0x00, 0x00, 0x00, 0x00, 0x00},
    ['6'] = {0x00, 0x00, 0x1C, 0x30, 0x60, 0x7C, 0x66, 0x66,
             0x66, 0x66, 0x3C, 0x00, 0x00, 0x00, 0x00, 0x00},
    ['7'] = {0x00, 0x00, 0x7E, 0x66, 0x06, 0x0C, 0x18, 0x18,
             0x18, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00},
    ['8'] = {0x00, 0x00, 0x3C, 0x66, 0x66, 0x66, 0x3C, 0x66,
             0x66, 0x66, 0x3C, 0x00, 0x00, 0x00, 0x00, 0x00},
    ['9'] = {0x00, 0x00, 0x3C, 0x66, 0x66, 0x66, 0x3E, 0x06,
             0x0C, 0x18, 0x70, 0x00, 0x00, 0x00, 0x00, 0x00},

    ['A'] = {0x00, 0x00, 0x18, 0x3C, 0x66, 0x66, 0x66, 0x7E,
             0x66, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00, 0x00},
    ['B'] = {0x00, 0x00, 0x7C, 0x66, 0x66, 0x66, 0x7C, 0x66,
             0x66, 0x66, 0x7C, 0x00, 0x00, 0x00, 0x00, 0x00},
    ['C'] = {0x00, 0x00, 0x3C, 0x66, 0x60, 0x60, 0x60, 0x60,
             0x60, 0x66, 0x3C, 0x00, 0x00, 0x00, 0x00, 0x00},
    ['D'] = {0x00, 0x00, 0x78, 0x6C, 0x66, 0x66, 0x66, 0x66,
             0x66, 0x6C, 0x78, 0x00, 0x00, 0x00, 0x00, 0x00},
    ['E'] = {0x00, 0x00, 0x7E, 0x60, 0x60, 0x60, 0x7C, 0x60,
             0x60, 0x60, 0x7E, 0x00, 0x00, 0x00, 0x00, 0x00},
    ['F'] = {0x00, 0x00, 0x7E, 0x60, 0x60, 0x60, 0x7C, 0x60,
             0x60, 0x60, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00},

    ['a'] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x3C, 0x06, 0x3E,
             0x66, 0x66, 0x3E, 0x00, 0x00, 0x00, 0x00, 0x00},
    ['b'] = {0x00, 0x00, 0x60, 0x60, 0x60, 0x7C, 0x66, 0x66,
             0x66, 0x66, 0x7C, 0x00, 0x00, 0x00, 0x00, 0x00},
    ['c'] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x3C, 0x66, 0x60,
             0x60, 0x66, 0x3C, 0x00, 0x00, 0x00, 0x00, 0x00},
    ['d'] = {0x00, 0x00, 0x06, 0x06, 0x06, 0x3E, 0x66, 0x66,
             0x66, 0x66, 0x3E, 0x00, 0x00, 0x00, 0x00, 0x00},
    ['e'] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x3C, 0x66, 0x7E,
             0x60, 0x66, 0x3C, 0x00, 0x00, 0x00, 0x00, 0x00},
};

void font_draw_char_builtin(uint32_t x, uint32_t y, char c, Color fg, Color bg) {
    uint8_t ch = (uint8_t)c;
    const uint8_t *glyph = builtin_font_8x16[ch];

    for (uint32_t row = 0; row < 16; row++) {
        uint8_t byte = glyph[row];
        for (uint32_t col = 0; col < 8; col++) {
            if (byte & (0x80 >> col)) {
                framebuffer_putpixel(x + col, y + row, fg);
            } else {
                framebuffer_putpixel(x + col, y + row, bg);
            }
        }
    }
}

void font_draw_string_builtin(uint32_t x, uint32_t y, const char *text, Color fg, Color bg) {
    uint32_t offset_x = 0;

    while (*text) {
        if (*text == '\n') {
            offset_x = 0;
            y += 16;
        } else {
            font_draw_char_builtin(x + offset_x, y, *text, fg, bg);
            offset_x += 8;
        }
        text++;
    }
}

void font_draw_char(Font *font, uint32_t x, uint32_t y, char c, Color fg, Color bg) {
    if (!font) {
        font_draw_char_builtin(x, y, c, fg, bg);
        return;
    }
    font_draw_char_builtin(x, y, c, fg, bg);
}

void font_draw_string(Font *font, uint32_t x, uint32_t y, const char *text, Color fg, Color bg) {
    if (!font) {
        font_draw_string_builtin(x, y, text, fg, bg);
        return;
    }
    font_draw_string_builtin(x, y, text, fg, bg);
}

uint32_t font_string_width(Font *font, const char *text) {
    (void)font;
    uint32_t len = 0;
    while (*text++) len++;
    return len * 8;
}

#endif // USE_FRAMEBUFFER
#endif // ifdef USE_FRAMEBUFFER

// Stub implementations when framebuffer is disabled
#if !defined(USE_FRAMEBUFFER) || !USE_FRAMEBUFFER

int font_init(void) {
    return 0;
}

Font* font_load_ttf(const uint8_t *ttf_data, uint32_t size, uint32_t font_size) {
    (void)ttf_data; (void)size; (void)font_size;
    return NULL;
}

void font_free(Font *font) {
    (void)font;
}

void font_set_default(Font *font) {
    (void)font;
}

Font* font_get_default(void) {
    return NULL;
}

uint32_t font_get_height(Font *font) {
    (void)font;
    return 16;
}

void font_draw_char_builtin(uint32_t x, uint32_t y, char c, Color fg, Color bg) {
    (void)x; (void)y; (void)c; (void)fg; (void)bg;
}

void font_draw_string_builtin(uint32_t x, uint32_t y, const char *text, Color fg, Color bg) {
    (void)x; (void)y; (void)text; (void)fg; (void)bg;
}

void font_draw_char(Font *font, uint32_t x, uint32_t y, char c, Color fg, Color bg) {
    (void)font; (void)x; (void)y; (void)c; (void)fg; (void)bg;
}

void font_draw_string(Font *font, uint32_t x, uint32_t y, const char *text, Color fg, Color bg) {
    (void)font; (void)x; (void)y; (void)text; (void)fg; (void)bg;
}

uint32_t font_string_width(Font *font, const char *text) {
    (void)font;
    uint32_t len = 0;
    while (*text++) len++;
    return len * 8;
}

#endif // !USE_FRAMEBUFFER
